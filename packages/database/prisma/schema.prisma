generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 0. Authentication & Authorization
enum Role {
  ADMIN
  PHARMACIST // Pharmacien (Peut gérer stock + ventes)
  CASHIER    // Caissier (Ventes uniquement)
}

enum Status {
  ACTIF
  INACTIF
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String    // Hashed
  name            String
  role            Role      @default(CASHIER)
  status          Status    @default(ACTIF)
  
  // Relations inverses
  stockMovements  StockMovement[]
  auditLogs       AuditLog[]
  transactions    Transaction[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("users")
}

// 1. Products (Référentiel Produit)
model Product {
  id              String   @id @default(uuid())
  dci             String   // Dénomination Commune Internationale
  name            String   // Nom commercial
  category        String   // Ex: Antibiotique, Analgésique
  minThreshold    Int      // Alerte Seuil Mini
  sellingPrice    Decimal  @default(0) // Prix de Vente Public
  status          Status   @default(ACTIF)
  
  // Identification
  codeMatrix      String?  @unique // DataMatrix complet
  barCode         String?  @unique // EAN13

  // Relations
  batches         Batch[]
  movements       StockMovement[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("products")
}

// 2. Stocks / Batches (Gestion des Lots)
model Batch {
  id              String   @id @default(uuid())
  batchNumber     String   // Numéro de lot (ex: LOT-123)
  expiryDate      DateTime // Date de péremption
  costPrice       Decimal  // PAMP (Prix d'Achat Moyen Pondéré)
  quantity        Int      // Stock physique actuel du lot

  // Relations
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  
  movements       StockMovement[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([expiryDate]) // Pour l'algo FEFO
  @@map("batches")
}

// 3. Stock Movements (Table IMMUABLE - Ledger)
enum MovementType {
  IN          // Entrée (Achat)
  OUT         // Sortie (Vente)
  BREAKAGE    // Casse
  RETURN      // Retour
  ADJUSTMENT  // Inventaire
}

model StockMovement {
  id              String       @id @default(uuid())
  type            MovementType
  quantity        Int          // Positif ou négatif selon le sens
  reason          String?
  
  // Relation User (Qui a fait le mouvement)
  userId          String       
  user            User         @relation(fields: [userId], references: [id])
  
  timestamp       DateTime     @default(now())

  // Relations
  productId       String
  product         Product      @relation(fields: [productId], references: [id])
  
  batchId         String
  batch           Batch        @relation(fields: [batchId], references: [id])

  transactionId   String?
  transaction     Transaction? @relation(fields: [transactionId], references: [id])

  @@map("stock_movements")
}

// 4. Financial Transactions (Lien Stock -> Finance)
model Transaction {
  id              String   @id @default(uuid())
  amount          Decimal
  type            String   // SALE, PURCHASE, REFUND
  paymentMethod   String   // CASH, CARD, INSURANCE, MOBILE_MONEY
  status          String   @default("COMPLETED") // COMPLETED, CANCELLED, PENDING
  
  // Insurance fields
  insuranceId     String?
  insurancePart   Decimal? @default(0)
  patientPart     Decimal? @default(0)
  insurance       Insurance? @relation(fields: [insuranceId], references: [id])

  // Relation User (Qui a encaissé)
  userId          String   @default("system")
  user            User?    @relation(fields: [userId], references: [id])

  // Relations
  movements       StockMovement[]
  
  createdAt       DateTime @default(now())

  @@index([userId])
  @@map("transactions")
}

model Insurance {
  id           String        @id @default(uuid())
  name         String        @unique
  code         String?       @unique
  percentage   Int           @default(0) // Taux de prise en charge par défaut
  status       Status        @default(ACTIF)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]

  @@map("insurances")
}

// 5. Audit Log (Sécurité)
model AuditLog {
  id              String   @id @default(uuid())
  action          String   // DELETE_PRODUCT, MANUAL_ADJUSTMENT
  details         Json?
  
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  timestamp       DateTime @default(now())

  @@map("audit_logs")
}
