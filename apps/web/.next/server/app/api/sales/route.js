(()=>{var e={};e.id=678,e.ids=[678],e.modules={6330:e=>{"use strict";e.exports=require("@prisma/client")},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},5511:e=>{"use strict";e.exports=require("crypto")},8208:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>c,serverHooks:()=>y,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{POST:()=>p});var a=r(1271),n=r(1232),i=r(8079),o=r(1238),u=r(9201),d=r(9206);async function p(e){try{let t=await (0,d.j2)();if(!t?.user?.id)return o.NextResponse.json({error:"Non autoris\xe9"},{status:401});let r=t.user.id,{items:s,paymentMethod:a}=await e.json();if(!s||0===s.length)return o.NextResponse.json({error:"Panier vide"},{status:400});let n=await u.z.$transaction(async e=>{let t=0,n=await e.transaction.create({data:{type:"SALE",amount:0,paymentMethod:a||"CASH",status:"COMPLETED",userId:r}});for(let a of s){let s=await e.batch.findMany({where:{productId:a.productId,quantity:{gt:0},expiryDate:{gt:new Date}},orderBy:{expiryDate:"asc"}}),i=a.quantity;for(let t of s){if(i<=0)break;let s=Math.min(t.quantity,i);await e.batch.update({where:{id:t.id},data:{quantity:{decrement:s}}}),await e.stockMovement.create({data:{type:"OUT",quantity:-s,reason:"Vente POS",productId:a.productId,batchId:t.id,userId:r,transactionId:n.id}}),i-=s}if(i>0)throw Error(`Stock insuffisant pour le produit ${a.productId}`);t+=a.quantity*Number(a.sellingPrice)}return await e.transaction.update({where:{id:n.id},data:{amount:t}}),{transaction:n}});return o.NextResponse.json({success:!0,transactionId:n.transaction.id})}catch(e){return console.error("Erreur Vente:",e),o.NextResponse.json({error:e.message||"Erreur interne"},{status:500})}}let c=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/sales/route",pathname:"/api/sales",filename:"route",bundlePath:"app/api/sales/route"},resolvedPagePath:"C:\\Users\\tinkpad\\Desktop\\Mes Nouveaux Projets\\Sahel Ubuntu Pharm\\apps\\web\\app\\api\\sales\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:l,workUnitAsyncStorage:h,serverHooks:y}=c;function w(){return(0,i.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:h})}},7032:()=>{},408:()=>{},9206:(e,t,r)=>{"use strict";r.d(t,{j2:()=>d,Y9:()=>l});var s=r(8481),a=r(1041),n=r(9201),i=r(8483),o=r(7334);async function u(e){try{return await n.z.user.findUnique({where:{email:e}})}catch(e){throw console.error("Failed to fetch user:",e),Error("Failed to fetch user.")}}let{auth:d,signIn:p,signOut:c,handlers:l}=(0,s.Ay)({pages:{signIn:"/login"},callbacks:{authorized({auth:e,request:{nextUrl:t}}){let r=!!e?.user;return!(t.pathname.startsWith("/dashboard")||t.pathname.startsWith("/pos")||t.pathname.startsWith("/inventory"))||!!r},session:async({session:e,token:t})=>(t.sub&&e.user&&(e.user.id=t.sub),t.role&&e.user&&(e.user.role=t.role),e),jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e)},providers:[],providers:[(0,a.A)({async authorize(e){let t=o.Ikc({email:o.YjP().email(),password:o.YjP().min(6)}).safeParse(e);if(t.success){let{email:e,password:r}=t.data,s=await u(e);if(!s)return null;if(await i.Ay.compare(r,s.password))return s}return console.log("Invalid credentials"),null}})]})},9201:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var s=r(6330);let a=globalThis.prisma??new s.PrismaClient({log:["error"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[207,48,483,150],()=>r(8208));module.exports=s})();