(()=>{var e={};e.id=678,e.ids=[678],e.modules={6330:e=>{"use strict";e.exports=require("@prisma/client")},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},5511:e=>{"use strict";e.exports=require("crypto")},7598:e=>{"use strict";e.exports=require("node:crypto")},8208:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>f,serverHooks:()=>S,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{POST:()=>m});var a=r(1271),i=r(1232),n=r(8079),o=r(1238),u=r(9201),c=r(9206),l=r(7334),d=r(2297);let p=l.Ikc({paymentMethod:l.k5n(["CASH","CARD","INSURANCE","MOBILE_MONEY"]).optional().default("CASH"),items:l.YOg(l.Ikc({productId:l.YjP().uuid(),quantity:l.aig().int().positive(),sellingPrice:l.KCZ([l.aig().nonnegative(),l.YjP().transform(e=>parseFloat(e))])})).min(1,"Panier vide")});async function m(e){try{let t=await (0,c.j2)();if(!t?.user?.id)return o.NextResponse.json({error:"Non autoris\xe9"},{status:401});let r=t.user.role;if(!r||!["CASHIER","PHARMACIST","ADMIN"].includes(r))return o.NextResponse.json({error:"Acc\xe8s refus\xe9: R\xf4le insuffisant"},{status:403});let s=t.user.id;if(!await (0,d.i)(`sales-${s}`))return o.NextResponse.json({error:"Trop de requ\xeates, veuillez patienter."},{status:429});let a=await e.json(),i=p.safeParse(a);if(!i.success)return o.NextResponse.json({error:"Donn\xe9es invalides",details:i.error.format()},{status:400});let{items:n,paymentMethod:l}=i.data,m=await u.z.$transaction(async e=>{let t=0,r=await e.transaction.create({data:{type:"SALE",amount:0,paymentMethod:l,status:"COMPLETED",userId:s}});for(let a of n){let i=await e.batch.findMany({where:{productId:a.productId,quantity:{gt:0},expiryDate:{gt:new Date}},orderBy:{expiryDate:"asc"}}),n=a.quantity;for(let t of i){if(n<=0)break;let i=Math.min(t.quantity,n);await e.batch.update({where:{id:t.id},data:{quantity:{decrement:i}}}),await e.stockMovement.create({data:{type:"OUT",quantity:-i,reason:"Vente POS",productId:a.productId,batchId:t.id,userId:s,transactionId:r.id}}),n-=i}if(n>0)throw Error(`Stock insuffisant pour le produit ${a.productId}`);t+=a.quantity*Number(a.sellingPrice)}return await e.transaction.update({where:{id:r.id},data:{amount:t}}),{transaction:r}});return o.NextResponse.json({success:!0,transactionId:m.transaction.id})}catch(e){return console.error("Erreur Vente:",e),o.NextResponse.json({error:e.message||"Erreur interne"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/sales/route",pathname:"/api/sales",filename:"route",bundlePath:"app/api/sales/route"},resolvedPagePath:"C:\\Users\\tinkpad\\Desktop\\Mes Nouveaux Projets\\Sahel Ubuntu Pharm\\apps\\web\\app\\api\\sales\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:h,workUnitAsyncStorage:y,serverHooks:S}=f;function w(){return(0,n.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:y})}},7032:()=>{},408:()=>{},9206:(e,t,r)=>{"use strict";r.d(t,{j2:()=>c,Y9:()=>p});var s=r(8481),a=r(1041),i=r(9201),n=r(8483),o=r(7334);async function u(e){try{return await i.z.user.findUnique({where:{email:e}})}catch(e){throw console.error("Failed to fetch user:",e),Error("Failed to fetch user.")}}let{auth:c,signIn:l,signOut:d,handlers:p}=(0,s.Ay)({pages:{signIn:"/login"},callbacks:{authorized({auth:e,request:{nextUrl:t}}){let r=!!e?.user;return!(t.pathname.startsWith("/dashboard")||t.pathname.startsWith("/pos")||t.pathname.startsWith("/inventory"))||!!r},session:async({session:e,token:t})=>(t.sub&&e.user&&(e.user.id=t.sub),t.role&&e.user&&(e.user.role=t.role),e),jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e)},session:{strategy:"jwt",maxAge:86400},useSecureCookies:!0,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}},providers:[],providers:[(0,a.A)({async authorize(e){let t=o.Ikc({email:o.YjP().email(),password:o.YjP().min(6)}).safeParse(e);if(t.success){let{email:e,password:r}=t.data,s=await u(e);if(!s)return null;if(await n.Ay.compare(r,s.password))return s}return console.log("Invalid credentials"),null}})]})},9201:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var s=r(6330);let a=globalThis.prisma??new s.PrismaClient({log:["error"]})},2297:(e,t,r)=>{"use strict";r.d(t,{i:()=>u});var s=r(6593),a=r(2674);let i=new Map,n=process.env.UPSTASH_REDIS_REST_URL&&process.env.UPSTASH_REDIS_REST_TOKEN?new a.Q({url:process.env.UPSTASH_REDIS_REST_URL,token:process.env.UPSTASH_REDIS_REST_TOKEN}):null,o=null;async function u(e){if(o)try{let{success:t}=await o.limit(e);return t}catch(e){return console.error("RateLimit Error (Redis):",e),!0}process.env.UPSTASH_REDIS_REST_URL||console.warn("⚠️ RateLimiter: Utilisation de la m\xe9moire en Production ! Configurez UPSTASH_REDIS_REST_URL.");let t=Date.now(),r=t-6e4,s=(i.get(e)||[]).filter(e=>e>r);if(s.length>=10)return!1;if(s.push(t),i.set(e,s),i.size>1e3)for(let[e,t]of i.entries())t.every(e=>e<r)&&i.delete(e);return!0}n&&(o=new s.Ratelimit({redis:n,limiter:s.Ratelimit.slidingWindow(10,"60 s"),analytics:!0,prefix:"@upstash/ratelimit"}))}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[207,48,483,150,954],()=>r(8208));module.exports=s})();