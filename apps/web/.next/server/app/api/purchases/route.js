(()=>{var e={};e.id=550,e.ids=[550],e.modules={6330:e=>{"use strict";e.exports=require("@prisma/client")},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},5511:e=>{"use strict";e.exports=require("crypto")},7598:e=>{"use strict";e.exports=require("node:crypto")},1071:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>m,serverHooks:()=>f,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{POST:()=>h});var a=r(1271),i=r(1232),n=r(8079),o=r(1238),u=r(9201),c=r(9206),p=r(7334),d=r(2297);let l=p.Ikc({supplier:p.YjP().optional(),items:p.YOg(p.Ikc({productId:p.YjP().uuid(),batchNumber:p.YjP().min(1),quantity:p.aig().int().positive(),costPrice:p.KCZ([p.aig().nonnegative(),p.YjP().transform(e=>parseFloat(e))]),expiryDate:p.YjP().refine(e=>!isNaN(Date.parse(e)),"Date invalide")})).min(1,"Aucun produit r\xe9ceptionn\xe9")});async function h(e){try{let t=await (0,c.j2)();if(!t?.user?.id)return o.NextResponse.json({error:"Non autoris\xe9"},{status:401});let r=t.user.role;if(!r||!["PHARMACIST","ADMIN"].includes(r))return o.NextResponse.json({error:"Acc\xe8s refus\xe9: R\xf4le insuffisant"},{status:403});let s=t.user.id;if(!await (0,d.i)(`purchases-${s}`))return o.NextResponse.json({error:"Trop de requ\xeates, veuillez patienter."},{status:429});let a=await e.json(),i=l.safeParse(a);if(!i.success)return o.NextResponse.json({error:"Donn\xe9es invalides",details:i.error.format()},{status:400});let{items:n,supplier:p}=i.data,h=await u.z.$transaction(async e=>{let t=0,r=await e.transaction.create({data:{type:"PURCHASE",amount:0,paymentMethod:"INVOICE",status:"COMPLETED",userId:s}});for(let a of n){let i=await e.batch.findFirst({where:{productId:a.productId,batchNumber:a.batchNumber}}),n=new Date(a.expiryDate);i?await e.batch.update({where:{id:i.id},data:{quantity:{increment:a.quantity}}}):i=await e.batch.create({data:{productId:a.productId,batchNumber:a.batchNumber,quantity:a.quantity,costPrice:a.costPrice,expiryDate:n}}),await e.stockMovement.create({data:{type:"IN",quantity:a.quantity,productId:a.productId,batchId:i.id,reason:`Livraison: ${p||"Fournisseur"}`,userId:s,transactionId:r.id}}),t+=a.quantity*Number(a.costPrice)}return await e.transaction.update({where:{id:r.id},data:{amount:t}}),{transaction:r}});return o.NextResponse.json({success:!0,transactionId:h.transaction.id,itemsCount:n.length})}catch(e){return console.error("Erreur Achat:",e),o.NextResponse.json({error:e.message||"Erreur interne"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/purchases/route",pathname:"/api/purchases",filename:"route",bundlePath:"app/api/purchases/route"},resolvedPagePath:"C:\\Users\\tinkpad\\Desktop\\Mes Nouveaux Projets\\Sahel Ubuntu Pharm\\apps\\web\\app\\api\\purchases\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:w,serverHooks:f}=m;function x(){return(0,n.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:w})}},7032:()=>{},408:()=>{},9206:(e,t,r)=>{"use strict";r.d(t,{j2:()=>c,Y9:()=>l});var s=r(8481),a=r(1041),i=r(9201),n=r(8483),o=r(7334);async function u(e){try{return await i.z.user.findUnique({where:{email:e}})}catch(e){throw console.error("Failed to fetch user:",e),Error("Failed to fetch user.")}}let{auth:c,signIn:p,signOut:d,handlers:l}=(0,s.Ay)({pages:{signIn:"/login"},callbacks:{authorized({auth:e,request:{nextUrl:t}}){let r=!!e?.user;return!(t.pathname.startsWith("/dashboard")||t.pathname.startsWith("/pos")||t.pathname.startsWith("/inventory"))||!!r},session:async({session:e,token:t})=>(t.sub&&e.user&&(e.user.id=t.sub),t.role&&e.user&&(e.user.role=t.role),e),jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e)},session:{strategy:"jwt",maxAge:86400},useSecureCookies:!0,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}},providers:[],providers:[(0,a.A)({async authorize(e){let t=o.Ikc({email:o.YjP().email(),password:o.YjP().min(6)}).safeParse(e);if(t.success){let{email:e,password:r}=t.data,s=await u(e);if(!s)return null;if(await n.Ay.compare(r,s.password))return s}return console.log("Invalid credentials"),null}})]})},9201:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var s=r(6330);let a=globalThis.prisma??new s.PrismaClient({log:["error"]})},2297:(e,t,r)=>{"use strict";r.d(t,{i:()=>u});var s=r(6593),a=r(2674);let i=new Map,n=process.env.UPSTASH_REDIS_REST_URL&&process.env.UPSTASH_REDIS_REST_TOKEN?new a.Q({url:process.env.UPSTASH_REDIS_REST_URL,token:process.env.UPSTASH_REDIS_REST_TOKEN}):null,o=null;async function u(e){if(o)try{let{success:t}=await o.limit(e);return t}catch(e){return console.error("RateLimit Error (Redis):",e),!0}process.env.UPSTASH_REDIS_REST_URL||console.warn("⚠️ RateLimiter: Utilisation de la m\xe9moire en Production ! Configurez UPSTASH_REDIS_REST_URL.");let t=Date.now(),r=t-6e4,s=(i.get(e)||[]).filter(e=>e>r);if(s.length>=10)return!1;if(s.push(t),i.set(e,s),i.size>1e3)for(let[e,t]of i.entries())t.every(e=>e<r)&&i.delete(e);return!0}n&&(o=new s.Ratelimit({redis:n,limiter:s.Ratelimit.slidingWindow(10,"60 s"),analytics:!0,prefix:"@upstash/ratelimit"}))}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[207,48,483,150,954],()=>r(1071));module.exports=s})();