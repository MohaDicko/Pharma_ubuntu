(()=>{var e={};e.id=550,e.ids=[550],e.modules={6330:e=>{"use strict";e.exports=require("@prisma/client")},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},5511:e=>{"use strict";e.exports=require("crypto")},1071:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>y,routeModule:()=>d,serverHooks:()=>m,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{POST:()=>p});var a=r(1271),n=r(1232),i=r(8079),o=r(1238),u=r(9201),c=r(9206);async function p(e){try{let t=await (0,c.j2)();if(!t?.user?.id)return o.NextResponse.json({error:"Non autoris\xe9"},{status:401});let r=t.user.id,{items:s,supplier:a}=await e.json();if(!s||0===s.length)return o.NextResponse.json({error:"Aucun produit r\xe9ceptionn\xe9"},{status:400});let n=await u.z.$transaction(async e=>{let t=0,n=await e.transaction.create({data:{type:"PURCHASE",amount:0,paymentMethod:"INVOICE",status:"COMPLETED",userId:r}});for(let i of s){let s=await e.batch.findFirst({where:{productId:i.productId,batchNumber:i.batchNumber}});s?await e.batch.update({where:{id:s.id},data:{quantity:{increment:i.quantity}}}):s=await e.batch.create({data:{productId:i.productId,batchNumber:i.batchNumber,quantity:i.quantity,costPrice:i.costPrice,expiryDate:new Date(i.expiryDate)}}),await e.stockMovement.create({data:{type:"IN",quantity:i.quantity,productId:i.productId,batchId:s.id,reason:`Livraison: ${a||"Fournisseur"}`,userId:r,transactionId:n.id}}),t+=i.quantity*Number(i.costPrice)}return await e.transaction.update({where:{id:n.id},data:{amount:t}}),{transaction:n}});return o.NextResponse.json({success:!0,transactionId:n.transaction.id,itemsCount:s.length})}catch(e){return console.error("Erreur Achat:",e),o.NextResponse.json({error:e.message||"Erreur interne"},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/purchases/route",pathname:"/api/purchases",filename:"route",bundlePath:"app/api/purchases/route"},resolvedPagePath:"C:\\Users\\tinkpad\\Desktop\\Mes Nouveaux Projets\\Sahel Ubuntu Pharm\\apps\\web\\app\\api\\purchases\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:l,workUnitAsyncStorage:h,serverHooks:m}=d;function y(){return(0,i.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:h})}},7032:()=>{},408:()=>{},9206:(e,t,r)=>{"use strict";r.d(t,{j2:()=>c,Y9:()=>l});var s=r(8481),a=r(1041),n=r(9201),i=r(8483),o=r(7334);async function u(e){try{return await n.z.user.findUnique({where:{email:e}})}catch(e){throw console.error("Failed to fetch user:",e),Error("Failed to fetch user.")}}let{auth:c,signIn:p,signOut:d,handlers:l}=(0,s.Ay)({pages:{signIn:"/login"},callbacks:{authorized({auth:e,request:{nextUrl:t}}){let r=!!e?.user;return!(t.pathname.startsWith("/dashboard")||t.pathname.startsWith("/pos")||t.pathname.startsWith("/inventory"))||!!r},session:async({session:e,token:t})=>(t.sub&&e.user&&(e.user.id=t.sub),t.role&&e.user&&(e.user.role=t.role),e),jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e)},providers:[],providers:[(0,a.A)({async authorize(e){let t=o.Ikc({email:o.YjP().email(),password:o.YjP().min(6)}).safeParse(e);if(t.success){let{email:e,password:r}=t.data,s=await u(e);if(!s)return null;if(await i.Ay.compare(r,s.password))return s}return console.log("Invalid credentials"),null}})]})},9201:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var s=r(6330);let a=globalThis.prisma??new s.PrismaClient({log:["error"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[207,48,483,150],()=>r(1071));module.exports=s})();